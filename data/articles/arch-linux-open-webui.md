
## 关于 Docker

虽然很早之前就听说过 Docker，不过从来没有仔细使用过。上次使用还是在打 Geekgame 2024 的时候，为了配置 Ubuntu 22.04 调试环境而进行了使用。

之前看过一种说法是说 Docker 最大的好处在于隔离了安装和配置某项服务的复杂度，我深以为然。尽管 Docker 本身并没有特别好学习，但是它的用法是大致固定的，很多服务可能手动配置还要比使用 Docker 简单得多，然而，对于一些难以配置和安装的服务，使用 Docker 安装复杂的服务并不会比安装简单的服务困难很多，而这，就是容器化的魅力啊（赞赏

这次也算是我第一次使用 Docker 配置了某个服务，就在这里记录一下。

## 关于 Open WebUI

Open WebUI 是一个用来方便调用 LLM API 的工具，它支持 Ollama 和 OpenAI API。我主要是把它作为 OpenAI API 的前端来使用。

相比 ChatBox 和 Page Assist 之类的前端，它有以下的优势：

* 支持联网搜索。原理是询问 LLM 检索词，然后通过搜索引擎 API 查询搜索结果，并按照设定的值（N）抓取前 N 个网页内容，进行 RAG 后传输给 GPT API。
* 支持代码执行器。利用了 Pyodide 这个沙盒 Python 环境。
* 支持文档上传和知识库。原理是 RAG.
* 社区资源丰富。它官方有一个类似于应用商店的地方，可以下载别的插件和工具之类的。

## 使用 Docker 安装 OpenWebUI

首先安装 Docker 的过程就略过了。`yay -S docker` 然后 `systemctl enable --now docker.socket`（注意是 docker.socket 不是 docker.service）然后 `sudo usermod -aG docker $USER`即可。因为教程随时可能过时，因此不建议你按照我这里说的步骤真的一步一步执行，而是到 ArchWiki 上查找最新信息才是最好的。值得一提的是如果 sudo docker info 一直没法正常返回信息的话试试重启一下可能会有帮助。

接下来就是使用 Docker 安装 Open WebUI 本身了。

这里先说一下我为什么不手动安装。官网确实提供了一种使用 Python PIP 安装的教程。`pip install open-webui` 即可。不过，它安装好之后需要下载 Pyodide 引擎，而且没有进度条。在我的环境下，尽管我已经配置好了透明代理，但是还是很慢，可能还是没走代理或者别的原因。AUR 里面的 open-webui 也是这种装法（指用 pip 安装），对于国内网络环境还是挺艰难的。当然也可能我个人环境原因，

所以我选用了 Docker 安装。同时也是熟悉一下 Docker 的使用。首先 Pull 镜像：

```
docker pull ghcr.io/open-webui/open-webui:main
```

然后初始化容器（注意每个人环境不同，请不要直接复制粘贴如下的命令）：

```
docker run -e http_proxy=http://127.0.0.1:1081 -e https_proxy=http://127.0.0.1:1081 -e PORT=3000 -d --network host -v open-webui:/app/backend/data --name open-webui ghcr.io/open-webui/open-webui:main
```

相比官方的初始化命令，我这个修改了几处。首先是关于 Docker 的网络模式。官方的教程里是使用了桥接网络的端口映射来实现（`-p:3000:8080`）。不过如果只有本机使用的话，可以改用`-p:127.0.0.1:3000:8080`。这会阻止所有来自外部的连接，更加安全。（当然代价是没有办法从外部连入了）。但是在这种方案下（指桥接网络），如果我需要让 Open WebUI 使用主机上的代理地址。那么就需要配置代理服务器允许外部连入，并且将容器内的代理地址配置为 docker0 网关地址而不是 127.0.0.1 上。让代理服务器允许外部连入（且不进行鉴权）其实是比较危险的。因此如果这样做，需要进行额外的防火墙配置，对我来说比较麻烦。

我改用了 Host 网络模式。在这个模式下，容器与主机共享同一个网络接口（interface），让 Open WebUI 直接监听在主机的网络上。在这种情况下仍然需要添加防火墙配置（如果你不希望服务被从外部连入），我使用的是 ufw:

```
sudo ufw deny 3000
```

实际上 OpenWebUI 自己有鉴权机制所以即使不进行防火墙配置也没有很大问题，不过那样的话密码就要设置的更强一点，并且开启禁止注册。

这里值得一提的是，虽然众所周知的是 UFW 不能用于管理 Docker 的网络（因为 Docker 创建的 iptables 规则会比 ufw 更早生效），但是这仅限于桥接模式。若使用 Host 网络模式，Docker 不会创建任何 iptables 规则，从而 UFW 的规则可以正常生效。

然后就是一些别的环境变量了，包括`http_proxy`和`https_proxy` 用于配置容器内的代理。还有默认的`8080`端口容易冲突，改用`3000`会更好。你可以根据自己的实际情况修改这些环境变量

## 使用 Open WebUI

可以使用`docker ps`命令查看容器内的状态，此外，`docker stop open-webui` 可以用来终止容器，`docker start open-webui` 可以用来启动容器。`docker rm open-webui` 可以用来删除容器。

## 配置 Open WebUI

我目前配置的项目也不多，不过可以列出目前配置的项目当中，踩到的一些坑。

首先是网络搜索。网络搜索实际上也使用 RAG。在我的环境下，RAG 并没有自动被配置。如果你确信自己已经正确配置了网络搜索，而且代理什么的也都是正确处理的，但是一直报错 Error searching XXXXX，可能是因为 RAG 没有正确配置好。打开管理员设置→文档→语义向量模型那里点一下旁边的下载按钮，然后按一下最下面的保存按钮，再试一次，可能就能正常工作了。

然后是一些容易混淆的概念，就是 Open WebUI 的工作空间包括那个类似应用商店的地方可以下载函数和工具，这两个概念其实是有区别的，函数（Functions）指的是 OpenWebUI 自己的插件，而工具（Tools）指的是 LLM 自己可以去调用的工具。如果搞混了就会出现达不到效果或者用不了的情况。

还有就是管理员面板里设置 OpenAI API 的那个地方，有时候删除某个提供商之后它实际上没删，刷新一下又出来了，这时候先把整个 OpenAI API 那一块全禁用掉，然后重新启用，就能正常删掉了。

还有就是它有一个叫 Direct Connections 的功能。这个实际上就是请求 LLM API 的时候浏览器自己去请求，而不是 Open WebUI 的后端服务去请求。这个可能部分情况下用得到。

## 总结

这次的配置总体上还是很有意义的，锻炼了使用 Docker 进行后端服务配置的能力。也是体会到了 Docker 的方便之处，在用于安装一些复杂服务的时候具有独特的优势。